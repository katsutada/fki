<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Login / Welcome System</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f4f9; }
        .content-wrapper { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
        input[type="password"] { padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .welcome-container { padding: 20px; }
    </style>
</head>
<body>
    <div class="content-wrapper" id="app-content">
        <h2>ğŸ” è«‹è¼¸å…¥å¯†ç¢¼</h2>
        <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
        <button onclick="attemptLogin()">ç™»å…¥</button>
    </div>

    <script src="pw.js"></script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡ DOM å…ƒç´  ---
        const appContent = document.getElementById('app-content');
        const APP_BASE_URL = window.location.pathname.replace('login.html', ''); 
        let idleInterval; // ç”¨ä¾†å„²å­˜è¨ˆæ™‚å™¨ ID

        // --- é–’ç½®è¨ˆæ™‚èˆ‡é©—è­‰é‚è¼¯ ---

        /** * æª¢æŸ¥ç™»å…¥ç‹€æ…‹æ˜¯å¦æœ‰æ•ˆæˆ–å·²é€¾æ™‚ã€‚
         * å¦‚æœéæœŸæˆ–æœªç™»å…¥ï¼Œå‰‡åŸ·è¡Œç™»å‡ºæ“ä½œã€‚
         */
        function checkAuthentication() {
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            const expiryTime = localStorage.getItem('loginExpiry');
            const currentTime = new Date().getTime();

            if (isAuthenticated !== 'true' || !expiryTime || currentTime > parseInt(expiryTime)) {
                
                // å¦‚æœå·²ç¶“ç™»å…¥ä½†æ™‚é–“éæœŸï¼Œå‰‡ç™¼å‡ºæç¤º
                if (isAuthenticated === 'true') { 
                    alert('é–’ç½®æ™‚é–“å·²é” 1 å°æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                }
                
                // åŸ·è¡Œè»Ÿç™»å‡ºï¼Œå›åˆ°ç™»å…¥ä»‹é¢
                handleLogout(false); // å‚³å…¥ false è¡¨ç¤ºé€™æ¬¡ç™»å‡ºä¸æ˜¯ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•
            }
        }

        /** * é‡ç½®é–’ç½®è¨ˆæ™‚å™¨ï¼šæ›´æ–°å„²å­˜çš„é€¾æ™‚æ™‚é–“ç‚ºæœªä¾† 1 å°æ™‚ã€‚
         */
        function resetIdleTimer() {
            const newExpiryTime = new Date().getTime() + (60 * 60 * 1000); // 1å°æ™‚
            localStorage.setItem('loginExpiry', newExpiryTime);
            // console.log('é–’ç½®è¨ˆæ™‚å™¨å·²é‡ç½®ã€‚');
        }

        /** * é–‹å§‹ç›£æ§ä½¿ç”¨è€…æ´»å‹•ä¸¦è¨­å®šå®šæ™‚æª¢æŸ¥ã€‚
         */
        function startIdleMonitoring() {
            // ç›£è½æ´»å‹•äº‹ä»¶ï¼šä»»ä½•æ´»å‹•éƒ½é‡ç½®è¨ˆæ™‚å™¨
            ['click', 'mousemove', 'keypress'].forEach(eventType => {
                document.addEventListener(eventType, resetIdleTimer, true);
            });

            // å®šæœŸæª¢æŸ¥ (æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡)
            idleInterval = setInterval(checkAuthentication, 60000); 
            console.log('é–’ç½®ç›£æ§å·²å•Ÿå‹•ã€‚');
        }

        /** * åœæ­¢æ‰€æœ‰ç›£æ§å’Œè¨ˆæ™‚å™¨ã€‚
         */
        function stopIdleMonitoring() {
            clearInterval(idleInterval);
            ['click', 'mousemove', 'keypress'].forEach(eventType => {
                document.removeEventListener(eventType, resetIdleTimer, true);
            });
            console.log('é–’ç½®ç›£æ§å·²åœæ­¢ã€‚');
        }

        // --- å°èˆªèˆ‡ç‹€æ…‹è™•ç†é‚è¼¯ ---

        /** * è™•ç†ä½¿ç”¨è€…é»æ“Šã€Œç™»å‡ºã€æˆ–ç³»çµ±å› é€¾æ™‚è€Œè§¸ç™¼çš„ç™»å‡ºã€‚
         */
        function handleLogout(isUserAction = true) {
            stopIdleMonitoring();

            // æ¸…é™¤æœ¬åœ°å„²å­˜
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('loginExpiry');
            
            // 1. é‡è¨­ URL å›åˆ°ç™»å…¥é é¢çš„ç‹€æ…‹ (ä¸åˆ·æ–°)
            // å°‡ History API çš„ URL è¨­å› login.htmlï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æ­£ç¢ºç¶²å€
            history.pushState({ page: 'login' }, 'Login', APP_BASE_URL + 'login.html');

            // 2. æ›¿æ›å›ç™»å…¥è¡¨å–®å…§å®¹
            appContent.innerHTML = `
                <h2>ğŸ” è«‹è¼¸å…¥å¯†ç¢¼</h2>
                <input type="password" id="passwordInput" placeholder="å¯†ç¢¼">
                <button onclick="attemptLogin()">ç™»å…¥</button>
            `;
            
            if (isUserAction) {
                alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
            }
        }


        /** * è¼‰å…¥ wel.html çš„å…§å®¹ç‰‡æ®µï¼Œä¸¦æ›´æ–° URLã€‚
         */
        async function loadWelcomePage() {
            try {
                const response = await fetch('wel.html');
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æ­¡è¿é é¢å…§å®¹ã€‚');
                
                const htmlContent = await response.text();
                
                // 1. æ›¿æ›å…§å®¹
                appContent.innerHTML = htmlContent;
                
                // 2. ä½¿ç”¨ History API æ›´æ”¹ URL
                // ç¶²å€æœƒè®Šç‚º /searchï¼Œä½†é é¢æ²’æœ‰åˆ·æ–°ï¼Œå¾è€Œé¿å…é¡¯ç¤º .html æª”æ¡ˆå
                history.pushState({ page: 'search' }, 'search', APP_BASE_URL + 'search');

                // 3. å•Ÿå‹•é–’ç½®ç›£æ§
                startIdleMonitoring();

            } catch (error) {
                console.error("è¼‰å…¥å…§å®¹éŒ¯èª¤:", error);
                alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥é é¢å…§å®¹ã€‚');
                handleLogout(false); // è¼‰å…¥å¤±æ•—ä¹Ÿè¦–ç‚ºç™»å‡º
            }
        }


        /** * è™•ç†ç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶ã€‚
         */
        function attemptLogin() {
            const inputElement = document.getElementById('passwordInput');
            const input = inputElement ? inputElement.value : '';
            
            if (input === CORRECT_PASSWORD) {
                // 1. è¨­ç½®ç™»å…¥ç‹€æ…‹å’Œé€¾æ™‚
                const expiryTime = new Date().getTime() + (60 * 60 * 1000); // 1å°æ™‚å¾Œ
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('loginExpiry', expiryTime);
                
                // 2. è¼‰å…¥æ­¡è¿é é¢
                loadWelcomePage();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
                if (inputElement) inputElement.value = ''; // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
            }
        }


        // --- é é¢åˆå§‹åŒ–æª¢æŸ¥ (è™•ç†é‡æ–°æ•´ç†æˆ–ç›´æ¥è¨ªå•) ---

        /** * é é¢è¼‰å…¥æ™‚é‹è¡Œï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ç™»å…¥ç‹€æ…‹ã€‚
         */
        function init() {
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            
            if (isAuthenticated === 'true') {
                // æª¢æŸ¥æ˜¯å¦å·²éæœŸ (å³ä½¿æ˜¯é‡æ–°æ•´ç†ä¹Ÿæª¢æŸ¥)
                checkAuthentication(); 
                
                // å¦‚æœ checkAuthentication æ²’æœ‰è§¸ç™¼ç™»å‡ºï¼Œå‰‡è¼‰å…¥æ­¡è¿é é¢
                if (localStorage.getItem('isAuthenticated') === 'true') {
                    loadWelcomePage();
                }
            }
            // å¦‚æœæ²’æœ‰ç™»å…¥ç‹€æ…‹ï¼Œå‰‡ä¿ç•™ç™»å…¥è¡¨å–® (login.html åˆå§‹ HTML)
        }

        // å•Ÿå‹•åˆå§‹åŒ–ç¨‹åº
        init();

    </script>
</body>
</html>